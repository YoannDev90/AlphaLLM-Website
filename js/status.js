const API_ENDPOINT=CONFIG.API.BASE_URL+CONFIG.API.STATUS_ENDPOINT,RESOURCES_ENDPOINT=CONFIG.API.BASE_URL+CONFIG.API.RESOURCES_ENDPOINT;let realtimeCpuRamChart,dailyCpuRamChart,resourcesEventSource;function showLoadingIndicator(){const e=document.getElementById("refresh-status-text");e&&(e.style.display="inline");const t=document.getElementById("update-time");t&&(t.style.opacity="0.5");const n=document.getElementById("refresh-status");n&&(n.disabled=!0,n.classList.add("refreshing"))}function showResourcesLoadingIndicator(){const e=document.getElementById("resources-refresh-status-text");e&&(e.style.display="inline");const t=document.getElementById("resources-update-time");t&&(t.style.opacity="0.5");const n=document.getElementById("refresh-resources");n&&(n.disabled=!0,n.classList.add("refreshing"))}function updateResourcesCharts(e){console.log("Mise à jour des graphiques avec les données:",e);const t=document.getElementById("realtime-cpu-ram-chart"),n=document.getElementById("daily-cpu-ram-chart");if(!t||!n)return console.warn("Éléments canvas non trouvés, réessai dans 100ms"),void setTimeout(()=>updateResourcesCharts(e),100);if("undefined"==typeof Chart)return console.warn("Chart.js n'est pas encore chargé, réessai dans 100ms"),void setTimeout(()=>updateResourcesCharts(e),100);const r=e.realtime.map(e=>new Date(e.timestamp).toLocaleTimeString(document.documentElement.lang||"fr-FR",{hour:"2-digit",minute:"2-digit",second:"2-digit"})),s=e.realtime.map(e=>e.cpu_percent),o=e.realtime.map(e=>e.memory_percent);console.log("Données temps réel préparées:",{labels:r.length,cpu:s.length,ram:o.length});const a=e.daily.map(e=>new Date(e.timestamp).toLocaleTimeString(document.documentElement.lang||"fr-FR",{hour:"2-digit",minute:"2-digit"})),i=e.daily.map(e=>e.cpu_percent),d=e.daily.map(e=>e.memory_percent);console.log("Données quotidiennes préparées:",{labels:a.length,cpu:i.length,ram:d.length});const l=document.getElementById("realtime-cpu-ram-chart").getContext("2d");realtimeCpuRamChart?(console.log("Mise à jour du graphique temps réel existant"),realtimeCpuRamChart.data.labels=r,realtimeCpuRamChart.data.datasets[0].data=s,realtimeCpuRamChart.data.datasets[1].data=o,realtimeCpuRamChart.update()):(console.log("Création du graphique temps réel"),realtimeCpuRamChart=new Chart(l,{type:"line",data:{labels:r,datasets:[{label:"CPU %",data:s,borderColor:"rgba(52, 152, 219, 1)",backgroundColor:"rgba(52, 152, 219, 0.1)",borderWidth:2,fill:!0,tension:.4,pointRadius:0,pointHoverRadius:0,yAxisID:"y"},{label:"RAM %",data:o,borderColor:"rgba(155, 89, 182, 1)",backgroundColor:"rgba(155, 89, 182, 0.1)",borderWidth:2,fill:!0,tension:.4,pointRadius:0,pointHoverRadius:0,yAxisID:"y1"}]},options:{responsive:!0,maintainAspectRatio:!0,plugins:{legend:{display:!0,position:"top"},tooltip:{mode:"index",intersect:!1,callbacks:{label:function(e){return 0===e.datasetIndex?`CPU: ${e.parsed.y.toFixed(1)}%`:`RAM: ${e.parsed.y.toFixed(1)}%`}}}},scales:{x:{display:!0,title:{display:!0,text:"Temps"}},y:{type:"linear",display:!0,position:"left",title:{display:!0,text:"CPU %"},beginAtZero:!0,max:100},y1:{type:"linear",display:!0,position:"right",title:{display:!0,text:"RAM %"},beginAtZero:!0,max:100,grid:{drawOnChartArea:!1}}},interaction:{mode:"nearest",axis:"x",intersect:!1}}}));const c=document.getElementById("daily-cpu-ram-chart").getContext("2d");dailyCpuRamChart?(dailyCpuRamChart.data.labels=a,dailyCpuRamChart.data.datasets[0].data=i,dailyCpuRamChart.data.datasets[1].data=d,dailyCpuRamChart.update()):dailyCpuRamChart=new Chart(c,{type:"line",data:{labels:a,datasets:[{label:"CPU %",data:i,borderColor:"rgba(46, 204, 113, 1)",backgroundColor:"rgba(46, 204, 113, 0.1)",borderWidth:2,fill:!0,tension:.4,pointRadius:0,pointHoverRadius:0,yAxisID:"y"},{label:"RAM %",data:d,borderColor:"rgba(230, 126, 34, 1)",backgroundColor:"rgba(230, 126, 34, 0.1)",borderWidth:2,fill:!0,tension:.4,pointRadius:0,pointHoverRadius:0,yAxisID:"y1"}]},options:{responsive:!0,maintainAspectRatio:!0,plugins:{legend:{display:!0,position:"top"},tooltip:{mode:"index",intersect:!1,callbacks:{label:function(e){return 0===e.datasetIndex?`CPU: ${e.parsed.y.toFixed(1)}%`:`RAM: ${e.parsed.y.toFixed(1)}%`}}}},scales:{x:{display:!0,title:{display:!0,text:"Heure"}},y:{type:"linear",display:!0,position:"left",title:{display:!0,text:"CPU %"},beginAtZero:!0,max:100},y1:{type:"linear",display:!0,position:"right",title:{display:!0,text:"RAM %"},beginAtZero:!0,max:100,grid:{drawOnChartArea:!1}}},interaction:{mode:"nearest",axis:"x",intersect:!1}}})}async function fetchStatusData(){try{const e=new Promise((e,t)=>{setTimeout(()=>t(new Error("Timeout: La requête a pris trop de temps")),5e3)}),t=fetch(`${API_ENDPOINT}`),n=await Promise.race([t,e]);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const r=await n.json();return console.log(r),{status:"success",timestamp:(new Date).toISOString(),bots:r.data_service}}catch(e){console.error("Erreur lors de la récupération des données:",e);let t=e.message;return e.message.includes("NetworkError")||e.message.includes("Mixed Content")?t="Impossible de charger les données: problème de sécurité HTTPS/HTTP.":e.message.includes("Timeout")&&(t="Délai d'attente dépassé: les services semblent indisponibles."),{status:"error",error:t,timestamp:(new Date).toISOString(),bots:null}}}function showErrorMessage(e){let t,n=document.getElementById("error-message");if(!n){n=document.createElement("div"),n.id="error-message",n.className="error-message";const e=document.getElementById("loading-indicator"),t=document.getElementById("refresh-status"),r=e||t;r&&r.parentNode&&r.parentNode.insertBefore(n,r.nextSibling)}if(window.i18n&&"function"==typeof window.i18n.translate){t=`${window.i18n.translate("status.error.loadingFailed")}: ${e}`}else{const n={fr:"Erreur lors du chargement des statuts",en:"Error loading bot statuses"};t=`${n[document.documentElement.lang||"fr"]||n.fr}: ${e}`}n.textContent=t,n.style.display="block"}function hideErrorMessage(){const e=document.getElementById("error-message");e&&(e.style.display="none")}function setAllBotsToError(){document.querySelectorAll(".bot-item").forEach(e=>{const t=e.querySelector(".status");if(t)if(t.className="status offline",t.setAttribute("data-i18n","status.offline"),window.i18n&&"function"==typeof window.i18n.translate){const e=window.i18n.translate("status.offline");t.textContent=e}else{const e=document.documentElement.lang||"fr",n={fr:"Hors ligne",en:"Offline"};t.textContent=n[e]||n.fr}})}async function fetchAndUpdateBotsStatus(){showLoadingIndicator();try{const e=await fetchStatusData();if("success"!==e.status||!e.bots)throw new Error(e.error||"Erreur inconnue");updateBotsStatusFromAPI(e.bots),hideErrorMessage()}catch(e){console.error("Erreur lors de la mise à jour des statuts:",e),showErrorMessage(e.message),setAllBotsToError()}finally{hideLoadingIndicator()}}async function fetchResourcesData(){try{const e=new Promise((e,t)=>{setTimeout(()=>t(new Error("Timeout: La requête a pris trop de temps")),5e3)}),t=fetch(RESOURCES_ENDPOINT),n=await Promise.race([t,e]);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const r=await n.json();return console.log("Resources data:",r),{status:"success",timestamp:(new Date).toISOString(),data:r}}catch(e){console.error("Erreur lors de la récupération des données de ressources:",e);let t=e.message;return e.message.includes("NetworkError")||e.message.includes("Mixed Content")?t="Impossible de charger les données de ressources: problème de sécurité HTTPS/HTTP.":e.message.includes("Timeout")&&(t="Délai d'attente dépassé: les services semblent indisponibles."),{status:"error",error:t,timestamp:(new Date).toISOString(),data:null}}}async function fetchAndUpdateResources(){showResourcesLoadingIndicator();try{const e=await fetchResourcesData();if("success"!==e.status||!e.data)throw new Error(e.error||"Erreur inconnue");updateResourcesCharts(e.data),hideResourcesErrorMessage()}catch(e){console.error("Erreur lors de la mise à jour des ressources:",e),showResourcesErrorMessage(e.message)}finally{hideResourcesLoadingIndicator()}}function updateBotsStatusFromAPI(e){const t={ChatGPT:"openai",Claude:"claude",Gemini:"gemini",Llama:"llama",DeepSeek:"deepseek",Mistral:"mistral",Grok:"grok",Perplexity:"mercury",Qwen:"qwen",Phi:"phi",GLM:"glm",Kimi:"kimi",EvilGPT:"evilgpt",Cohere:"cohere",Yi:"yi","Hermès":"hermes",Nemotron:"nemotron",MiniMax:"minimax",Inception:"granite",LongCat:"longcat",Seed:"seed"};document.querySelectorAll(".bot-item").forEach(n=>{const r=n.querySelector(".bot-info h3");if(!r)return;const s=r.textContent.trim(),o=t[s],a=o?e[o]:null;let i,d;if(a){switch(a.toLowerCase()){case"online":i="online",d="status.online";break;case"degraded":i="degraded",d="status.degraded";break;case"offline":i="offline",d="status.offline";break;default:i="offline",d="status.unknown"}}else console.warn(`Aucune donnée disponible pour le bot: ${s} - considéré comme offline`),i="offline",d="status.offline";const l=n.querySelector(".status");if(l)if(l.className="status "+i,l.setAttribute("data-i18n",d),window.i18n&&"function"==typeof window.i18n.translate){const e=window.i18n.translate(d);l.textContent=e}else{const e={"status.online":{fr:"En ligne",en:"Online"},"status.offline":{fr:"Hors ligne",en:"Offline"},"status.degraded":{fr:"Dégradé",en:"Degraded"},"status.unknown":{fr:"Inconnu",en:"Unknown"}},t=document.documentElement.lang||"fr",n=e[d];l.textContent=n&&n[t]||n?.fr||"Unknown"}n.classList.add("updating"),setTimeout(()=>{n.classList.remove("updating")},500)}),window.i18n&&"function"==typeof window.i18n.updatePageTranslations&&window.i18n.updatePageTranslations()}function hideResourcesLoadingIndicator(){const e=document.getElementById("resources-refresh-status-text");e&&(e.style.display="none");const t=document.getElementById("resources-update-time");t&&(t.style.opacity="1");const n=document.getElementById("refresh-resources");n&&(n.disabled=!1,n.classList.remove("refreshing"))}function showResourcesErrorMessage(e){let t,n=document.getElementById("resources-error-message");if(!n){n=document.createElement("div"),n.id="resources-error-message",n.className="error-message";const e=document.querySelector(".system-resources");if(e){const t=e.querySelector(".charts-container");t&&t.parentNode.insertBefore(n,t)}}if(window.i18n&&"function"==typeof window.i18n.translate){t=`${window.i18n.translate("status.error.loadingFailed")}: ${e}`}else{const n={fr:"Erreur lors du chargement des ressources",en:"Error loading system resources"};t=`${n[document.documentElement.lang||"fr"]||n.fr}: ${e}`}n.textContent=t,n.style.display="block"}function hideResourcesErrorMessage(){const e=document.getElementById("resources-error-message");e&&(e.style.display="none")}function hideLoadingIndicator(){const e=document.getElementById("refresh-status-text");e&&(e.style.display="none");const t=document.getElementById("update-time");t&&(t.style.opacity="1");const n=document.getElementById("refresh-status");n&&(n.disabled=!1,n.classList.remove("refreshing"))}function updateStatusTime(){const e=(new Date).toLocaleDateString(document.documentElement.lang||"fr-FR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});document.getElementById("update-time").textContent=e}function updateResourcesTime(){const e=(new Date).toLocaleDateString(document.documentElement.lang||"fr-FR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});document.getElementById("resources-update-time").textContent=e}function startResourcesSSE(){resourcesEventSource&&resourcesEventSource.close(),resourcesEventSource=new EventSource(RESOURCES_ENDPOINT),resourcesEventSource.onmessage=function(e){try{const t=JSON.parse(e.data);console.log("SSE data received:",t),updateResourcesCharts(t),updateResourcesTime(),hideResourcesErrorMessage()}catch(e){console.error("Erreur lors du parsing des données SSE:",e),showResourcesErrorMessage("Erreur de format des données reçues")}},resourcesEventSource.onerror=function(e){console.error("Erreur SSE:",e),showResourcesErrorMessage("Connexion perdue avec le serveur de ressources")},resourcesEventSource.onopen=function(){console.log("Connexion SSE ouverte pour les ressources")}}function initStatusPage(){console.log("Initialisation de la page status...");const e=document.getElementById("realtime-cpu-ram-chart"),t=document.getElementById("daily-cpu-ram-chart");if(!e||!t)return console.warn("Éléments canvas non trouvés, attente..."),void setTimeout(initStatusPage,500);if("undefined"==typeof Chart)return console.warn("Chart.js non chargé, attente..."),void setTimeout(initStatusPage,500);console.log("Tous les éléments chargés, démarrage..."),fetchAndUpdateBotsStatus(),updateStatusTime(),startResourcesSSE();const n=document.getElementById("refresh-status");n&&n.addEventListener("click",function(){fetchAndUpdateBotsStatus(),updateStatusTime()});const r=document.getElementById("refresh-resources");r&&r.addEventListener("click",function(){startResourcesSSE()})}document.head.insertAdjacentHTML("beforeend","\n<style>\n.refreshing {\n    opacity: 0.6;\n    cursor: not-allowed !important;\n}\n\n.refreshing::after {\n    content: '';\n    position: absolute;\n    width: 100%;\n    height: 100%;\n    background: linear-gradient(45deg, transparent 30%, rgba(var(--color-primary-rgb), 0.3) 50%, transparent 70%);\n    animation: shimmer 1.5s infinite;\n    border-radius: inherit;\n}\n\n@keyframes shimmer {\n    0% { transform: translateX(-100%); }\n    100% { transform: translateX(100%); }\n}\n\n.updating {\n    animation: pulse 0.5s ease-in-out;\n}\n\n@keyframes pulse {\n    0% { transform: scale(1); }\n    50% { transform: scale(1.02); }\n    100% { transform: scale(1); }\n}\n\n/* Pour l'affichage d'erreurs et le chargement */\n.error-message {\n    background-color: rgba(231, 76, 60, 0.1);\n    border-left: 4px solid #e74c3c;\n    padding: 1rem;\n    margin: 1rem 0;\n    color: #e74c3c;\n    border-radius: 4px;\n}\n\n.loading-indicator {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    margin: 2rem 0;\n}\n\n.loading-spinner {\n    width: 40px;\n    height: 40px;\n    border: 4px solid rgba(var(--color-primary-rgb), 0.1);\n    border-left-color: var(--color-primary);\n    border-radius: 50%;\n    animation: spin 1s linear infinite;\n}\n\n@keyframes spin {\n    to { transform: rotate(360deg); }\n}\n\n/* Indicateur de chargement pour le bouton refresh */\n.refresh-loading {\n    position: relative;\n    display: inline-flex;\n    align-items: center;\n    gap: 0.5rem;\n}\n\n.refresh-loading::after {\n    content: '';\n    width: 12px;\n    height: 12px;\n    border: 2px solid transparent;\n    border-top-color: var(--color-primary);\n    border-radius: 50%;\n    animation: spin 1s linear infinite;\n}\n</style>\n"),setInterval(()=>{fetchAndUpdateBotsStatus(),updateStatusTime()},6e4),window.addEventListener("load",function(){setTimeout(initStatusPage,100)});